<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ZITRONTCHIK | ARENA ABILITIES</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #0f0; text-align: center; margin: 0; user-select: none; }
        #arena { background: #111; border: 3px solid #f00; width: 100%; height: 450px; position: relative; overflow: hidden; margin: 20px auto; max-width: 850px; cursor: crosshair; display: none; }
        
        /* –õ–û–ë–ë–ò */
        #lobby { padding: 50px; }
        .weapon-select { display: flex; justify-content: center; gap: 20px; margin-top: 30px; flex-wrap: wrap; }
        .weapon-btn { background: #222; border: 2px solid #0f0; border-radius: 15px; padding: 20px; cursor: pointer; transition: 0.3s; width: 150px; box-shadow: 0 0 10px rgba(0,255,0,0.5); }
        .weapon-btn:hover { background: #0f0; transform: scale(1.1); box-shadow: 0 0 20px #0f0; }
        .weapon-btn span { font-size: 50px; display: block; margin-bottom: 10px; }
        .weapon-btn b { color: #fff; font-size: 16px; display: block; }
        .weapon-btn p { color: #ccc; font-size: 12px; margin-top: 5px; }

        /* –ò–ì–†–û–ö–ò –ò –û–†–£–ñ–ò–ï */
        .player { position: absolute; width: 40px; height: 40px; border-radius: 8px; background: #0f0; z-index: 5; transition: 0.1s linear; }
        .player.me { background: #00f; border: 2px solid white; box-shadow: 0 0 15px #00f; z-index: 10; }
        .player.stunned { background: #ffc107; border-color: #ffeb3b; animation: stun-flash 0.5s infinite; }
        .player.invulnerable { background: #8bc34a; border-color: #cddc39; animation: invuln-flash 0.2s infinite; }
        @keyframes stun-flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes invuln-flash { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }


        .weapon { position: absolute; font-size: 25px; transition: 0.1s; pointer-events: none; z-index: 15; transform-origin: center; }
        .attacking { animation: strike 0.2s ease-in-out; }
        @keyframes strike { 0% {transform: rotate(0deg) scale(1);} 50% {transform: rotate(-45deg) scale(2);} 100% {transform: rotate(0deg) scale(1);} }

        /* –°–ü–û–°–û–ë–ù–û–°–¢–ò */
        .ability-vfx { position: absolute; font-size: 30px; pointer-events: none; animation: fly-away 0.8s forwards; z-index: 20; }
        @keyframes fly-away { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(2); } }
        
        .banana-peel { position: absolute; font-size: 25px; pointer-events: none; z-index: 1; opacity: 0.8; }
        
        .hp { width: 45px; height: 6px; background: #333; position: absolute; top: -12px; border-radius: 3px; border: 1px solid #000; }
        .hp-fill { height: 100%; background: #0f0; transition: 0.3s; }
        .name { font-size: 11px; position: absolute; top: -28px; width: 120px; left: -40px; color: #fff; font-weight: bold; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ë–û–Ø */
        #ability-ui { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px; border: 1px solid #0f0; display: none; }
        #ability-ui div { display: flex; align-items: center; color: #fff; }
        #ability-ui span { font-size: 24px; margin-right: 10px; }
        #cooldown-bar { width: 100px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-left: 10px; }
        #cooldown-fill { height: 100%; width: 0%; background: #00f; transition: width 0.1s linear; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color: #0f0; text-shadow: 0 0 15px #0f0;">–í–´–ë–ï–†–ò –°–í–û–ô –ë–û–ï–í–û–ô –°–¢–ò–õ–¨</h1>
        <div class="weapon-select">
            <div class="weapon-btn" onclick="selectWeapon('üó°Ô∏è', '–ú–ï–ß', '–†—ã–≤–æ–∫ –≤–ø–µ—Ä–µ–¥')"><span>üó°Ô∏è</span><b>–ú–ï–ß</b><p>F: –†—ã–≤–æ–∫ (–±—ã—Å—Ç—Ä–æ–µ —Å–±–ª–∏–∂–µ–Ω–∏–µ)</p></div>
            <div class="weapon-btn" onclick="selectWeapon('üçã', '–õ–ò–ú–û–ù', '–ö–∏—Å–ª–æ—Ç–Ω—ã–π –°–ø–ª–µ—à')"><span>üçã</span><b>–õ–ò–ú–û–ù</b><p>F: –ö–∏—Å–ª–æ—Ç–Ω—ã–π –°–ø–ª–µ—à (–¥–∞–ª—å–Ω–∏–π —É—Ä–æ–Ω)</p></div>
            <div class="weapon-btn" onclick="selectWeapon('ü•ñ', '–ë–ê–ì–ï–¢', '–ó–∞—â–∏—Ç–Ω—ã–π –ë–∞—Ç–æ–Ω')"><span>ü•ñ</span><b>–ë–ê–ì–ï–¢</b><p>F: –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å (–∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)</p></div>
            <div class="weapon-btn" onclick="selectWeapon('üé∏', '–ì–ò–¢–ê–†–ê', '–ó–≤—É–∫–æ–≤–∞—è –í–æ–ª–Ω–∞')"><span>üé∏</span><b>–ì–ò–¢–ê–†–ê</b><p>F: –ó–≤—É–∫–æ–≤–∞—è –í–æ–ª–Ω–∞ (–ê–û–ï —É—Ä–æ–Ω)</p></div>
            <div class="weapon-btn" onclick="selectWeapon('üçå', '–ë–ê–ù–ê–ù', '–ë–∞–Ω–∞–Ω–æ–≤–∞—è –õ–æ–≤—É—à–∫–∞')"><span>üçå</span><b>–ë–ê–ù–ê–ù</b><p>F: –ë–∞–Ω–∞–Ω–æ–≤–∞—è –∫–æ–∂—É—Ä–∞ (–æ–±–µ–∑–¥–≤–∏–∂–∏–≤–∞–Ω–∏–µ)</p></div>
        </div>
    </div>

    <div id="arena" onmousedown="doAttack(event)"></div>

    <div id="ability-ui">
        <div>
            <span id="ability-icon"></span>
            <div id="cooldown-bar"><div id="cooldown-fill"></div></div>
        </div>
    </div>

<script>
    const config = {
        databaseURL: "https://zitron-blog-default-rtdb.firebaseio.com",
        projectId: "zitron-blog"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    let myId = "Zitron_" + Math.floor(Math.random()*99);
    let p = { 
        x: 150, y: 350, vy: 0, hp: 100, 
        isAttacking: false, weapon: "üó°Ô∏è", 
        isInvulnerable: false, isStunned: false,
        cooldown: 0, maxCooldown: 5000 // 5 —Å–µ–∫—É–Ω–¥
    };
    let keys = {};
    let gameActive = false;

    function selectWeapon(emoji, name, description) {
        p.weapon = emoji;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('arena').style.display = 'block';
        document.getElementById('ability-ui').style.display = 'flex';
        document.getElementById('ability-icon').innerText = emoji;
        gameActive = true;
        
        db.ref('players/' + myId).set(p);
        db.ref('players/' + myId).onDisconnect().remove();
    }

    window.onkeydown = (e) => {
        keys[e.code] = true;
        if (e.code === 'KeyF' && gameActive && p.cooldown <= 0) {
            useAbility();
        }
    };
    window.onkeyup = (e) => keys[e.code] = false;

    setInterval(() => {
        if (!gameActive || p.hp <= 0) return;
        if (p.isStunned) return; // –ù–µ –¥–≤–∏–≥–∞–µ–º—Å—è, –µ—Å–ª–∏ –æ–≥–ª—É—à–µ–Ω—ã

        if (keys['KeyA']) p.x -= 7;
        if (keys['KeyD']) p.x += 7;
        if (keys['Space'] && p.y >= 350) p.vy = -16;
        p.vy += 0.9; p.y += p.vy;
        if (p.y > 350) { p.y = 350; p.vy = 0; }
        if (p.x < 0) p.x = 0;
        if (p.x > 800) p.x = 800;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫—É
        if (p.cooldown > 0) {
            p.cooldown -= 30; // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (p.cooldown < 0) p.cooldown = 0;
            const cooldownPercent = (p.cooldown / p.maxCooldown) * 100;
            document.getElementById('cooldown-fill').style.width = cooldownPercent + '%';
        } else {
            document.getElementById('cooldown-fill').style.width = '0%';
        }

        db.ref('players/' + myId).update(p);
    }, 30);

    // –°–ü–û–°–û–ë–ù–û–°–¢–ò
    function useAbility() {
        p.cooldown = p.maxCooldown; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ö–î
        db.ref('players/' + myId).update({ cooldown: p.cooldown });

        switch(p.weapon) {
            case 'üó°Ô∏è': // –ú–ï–ß - –†—ã–≤–æ–∫
                const dashDistance = 150;
                p.x += (keys['KeyD'] ? dashDistance : (keys['KeyA'] ? -dashDistance : 0)); // –†—ã–≤–æ–∫ –≤ —Å—Ç–æ—Ä–æ–Ω—É –¥–≤–∏–∂–µ–Ω–∏—è
                db.ref('players/' + myId).update({ x: p.x });
                break;
            case 'üçã': // –õ–ò–ú–û–ù - –ö–∏—Å–ª–æ—Ç–Ω—ã–π –°–ø–ª–µ—à (–¥–∞–ª—å–Ω–∏–π —É—Ä–æ–Ω)
                const splashX = p.x + (keys['KeyD'] ? 100 : (keys['KeyA'] ? -100 : 0)); // –õ–∏–º–æ–Ω –ª–µ—Ç–∏—Ç –≤–ø–µ—Ä–µ–¥
                const splashY = p.y;

                const vfxSplash = document.createElement('div');
                vfxSplash.className = 'ability-vfx';
                vfxSplash.innerText = 'üçãüí•';
                vfxSplash.style.left = splashX + 'px';
                vfxSplash.style.top = splashY + 'px';
                document.getElementById('arena').appendChild(vfxSplash);
                setTimeout(() => vfxSplash.remove(), 800);

                db.ref('players').once('value', (s) => {
                    const players = s.val();
                    for(let id in players) {
                        if(id !== myId) {
                            const target = players[id];
                            const dist = Math.hypot(splashX - (target.x+20), splashY - (target.y+20));
                            if(dist < 80 && !target.isInvulnerable) { // –†–∞–¥–∏—É—Å —Å–ø–ª–µ—à–∞
                                db.ref('players/' + id + '/hp').transaction(h => (h || 100) - 25);
                            }
                        }
                    }
                });
                break;
            case 'ü•ñ': // –ë–ê–ì–ï–¢ - –ó–∞—â–∏—Ç–Ω—ã–π –ë–∞—Ç–æ–Ω (–Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å)
                p.isInvulnerable = true;
                db.ref('players/' + myId).update({ isInvulnerable: true });
                setTimeout(() => {
                    p.isInvulnerable = false;
                    db.ref('players/' + myId).update({ isInvulnerable: false });
                }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
                break;
            case 'üé∏': // –ì–ò–¢–ê–†–ê - –ó–≤—É–∫–æ–≤–∞—è –í–æ–ª–Ω–∞ (–ê–û–ï —É—Ä–æ–Ω)
                const vfxWave = document.createElement('div');
                vfxWave.className = 'ability-vfx';
                vfxWave.innerText = 'üé∂';
                vfxWave.style.left = p.x + 'px';
                vfxWave.style.top = p.y + 'px';
                document.getElementById('arena').appendChild(vfxWave);
                setTimeout(() => vfxWave.remove(), 800);

                db.ref('players').once('value', (s) => {
                    const players = s.val();
                    for(let id in players) {
                        if(id !== myId) {
                            const target = players[id];
                            const dist = Math.hypot(p.x - target.x, p.y - target.y);
                            if(dist < 150 && !target.isInvulnerable) { // –†–∞–¥–∏—É—Å –≤–æ–ª–Ω—ã
                                db.ref('players/' + id + '/hp').transaction(h => (h || 100) - 20);
                            }
                        }
                    }
                });
                break;
            case 'üçå': // –ë–ê–ù–ê–ù - –ë–∞–Ω–∞–Ω–æ–≤–∞—è –õ–æ–≤—É—à–∫–∞ (–æ–±–µ–∑–¥–≤–∏–∂–∏–≤–∞–Ω–∏–µ)
                const peelX = p.x + 20;
                const peelY = 380; // –ù–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª–∞

                const peelDiv = document.createElement('div');
                peelDiv.className = 'banana-peel';
                peelDiv.innerText = 'üçå';
                peelDiv.style.left = peelX + 'px';
                peelDiv.style.top = peelY + 'px';
                document.getElementById('arena').appendChild(peelDiv);

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–∂—É—Ä—É –≤ Firebase, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ –µ–µ –≤–∏–¥–µ–ª–∏
                db.ref('peels').push({ x: peelX, y: peelY, createdAt: firebase.database.ServerValue.TIMESTAMP });

                setTimeout(() => {
                    peelDiv.remove();
                    // –£–¥–∞–ª—è–µ–º –∫–æ–∂—É—Ä—É –∏–∑ Firebase —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    db.ref('peels').orderByChild('createdAt').limitToLast(1).once('child_added', (snapshot) => {
                        db.ref('peels/' + snapshot.key).remove();
                    });
                }, 5000);
                break;
        }
    }

    // –õ–û–ì–ò–ö–ê –ë–ê–ù–ê–ù–û–í–û–ô –ö–û–ñ–£–†–´ (–ù–∞–Ω–µ—Å–µ–Ω–∏–µ –æ–≥–ª—É—à–µ–Ω–∏—è)
    db.ref('peels').on('child_added', (snapshot) => {
        const peelData = snapshot.val();
        const arena = document.getElementById('arena');
        const peelDiv = document.createElement('div');
        peelDiv.className = 'banana-peel';
        peelDiv.innerText = 'üçå';
        peelDiv.style.left = peelData.x + 'px';
        peelDiv.style.top = peelData.y + 'px';
        arena.appendChild(peelDiv);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∫–æ–∂—É—Ä–æ–π
        db.ref('players').once('value', (s) => {
            const players = s.val();
            for (let idPlayer in players) {
                const player = players[idPlayer];
                const dist = Math.hypot(peelData.x - (player.x + 20), peelData.y - (player.y + 20));
                if (dist < 50 && idPlayer !== myId && !player.isInvulnerable) { // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞—Å—Ç—É–ø–∏–ª –Ω–∞ –∫–æ–∂—É—Ä—É
                    db.ref('players/' + idPlayer).update({ isStunned: true });
                    setTimeout(() => {
                        db.ref('players/' + idPlayer).update({ isStunned: false });
                    }, 2000); // –û–≥–ª—É—à–µ–Ω–∏–µ –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
                }
            }
        });

        // –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª –∫–æ–∂—É—Ä—ã, –∫–æ–≥–¥–∞ –æ–Ω–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ –±–∞–∑—ã
        snapshot.ref.on('child_removed', () => {
            peelDiv.remove();
        });
    });


    // –û–¢–†–ò–°–û–í–ö–ê –ò–ì–†–û–ö–û–í
    db.ref('players').on('value', (s) => {
        if (!gameActive) return;
        const arena = document.getElementById('arena');
        arena.querySelectorAll('.player').forEach(el => el.remove());
        arena.querySelectorAll('.weapon').forEach(el => el.remove());
        
        const players = s.val();
        if(!players) return;

        for(let id in players) {
            const d = players[id];
            
            const pDiv = document.createElement('div');
            pDiv.className = 'player' + (id === myId ? ' me' : '') + (d.isStunned ? ' stunned' : '') + (d.isInvulnerable ? ' invulnerable' : '');
            pDiv.style.left = d.x + 'px'; 
            pDiv.style.top = d.y + 'px';
            
            const wDiv = document.createElement('div');
            wDiv.className = 'weapon' + (d.isAttacking ? ' attacking' : '');
            wDiv.innerText = d.weapon;
            wDiv.style.left = (d.x + 35) + 'px';
            wDiv.style.top = (d.y + 5) + 'px';

            pDiv.innerHTML = `
                <div class="hp"><div class="hp-fill" style="width:${d.hp}%"></div></div>
                <div class="name">${id}</div>
            `;
            
            arena.appendChild(pDiv);
            arena.appendChild(wDiv);
            
            if(d.hp <= 0 && id === myId) {
                gameActive = false;
                alert("–¢–´ –ü–†–û–ò–ì–†–ê–õ! –í—ã–±–µ—Ä–∏ –Ω–æ–≤–æ–µ –æ—Ä—É–∂–∏–µ.");
                location.reload(); 
            }
        }
    });

    // –û–ë–´–ß–ù–ê–Ø –ê–¢–ê–ö–ê (–õ–ö–ú)
    function doAttack(e) {
        if(!gameActive || p.isAttacking) return;
        p.isAttacking = true;
        db.ref('players/' + myId).update({ isAttacking: true });

        db.ref('players').once('value', (s) => {
            const players = s.val();
            for(let id in players) {
                if(id !== myId) {
                    const target = players[id];
                    const dist = Math.hypot(p.x - target.x, p.y - target.y);
                    if(dist < 75 && !target.isInvulnerable) { 
                        db.ref('players/' + id + '/hp').transaction(h => (h || 100) - 10);
                    }
                }
            }
        });

        setTimeout(() => {
            p.isAttacking = false;
            db.ref('players/' + myId).update({ isAttacking: false });
        }, 200);
    }
</script>
</body>
</html>
