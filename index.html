<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ZITRON ARENA | ABILITIES FIXED</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #050505; color: #0f0; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        #lobby { padding: 50px; }
        .weapon-btn { background: #111; border: 2px solid #0f0; color: white; padding: 15px; margin: 10px; cursor: pointer; border-radius: 10px; display: inline-block; width: 160px; }
        .weapon-btn:hover { background: #0f0; color: black; transform: scale(1.1); }
        .weapon-btn p { font-size: 10px; color: #aaa; margin: 5px 0 0; }
        
        #arena { background: #111; border: 5px solid #f00; width: 95vw; height: 70vh; margin: 10px auto; position: relative; overflow: hidden; display: none; }
        
        .player { position: absolute; width: 40px; height: 40px; border-radius: 8px; transition: 0.05s linear; }
        .player.me { background: #00f; border: 2px solid #fff; box-shadow: 0 0 15px #00f; }
        .player.enemy { background: #f00; border: 2px solid #ff4d4d; }
        .player.invul { box-shadow: 0 0 25px #fff; filter: brightness(1.5); }
        
        .hp-container { width: 50px; height: 6px; background: #333; position: absolute; top: -15px; left: -5px; border-radius: 3px; }
        .hp-bar { height: 100%; background: #0f0; transition: width 0.2s; }
        .name { position: absolute; top: -30px; width: 100px; left: -30px; font-size: 10px; color: white; }
        .weapon-icon { position: absolute; font-size: 25px; pointer-events: none; z-index: 20; }
        
        .atk-anim { animation: swipe 0.2s ease-in-out; }
        @keyframes swipe { 0% { transform: scale(1); } 50% { transform: scale(1.8) rotate(30deg); } 100% { transform: scale(1); } }
        
        #hud { display: none; color: white; font-weight: bold; padding: 10px; }
        .cd-bar { display: inline-block; width: 100px; height: 10px; background: #333; border-radius: 5px; vertical-align: middle; }
        #cd-fill { height: 100%; width: 0%; background: #0f0; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>üçã ZITRON ARENA ‚öîÔ∏è</h1>
        <div class="weapon-btn" onclick="enterGame('üó°Ô∏è')"><b>–ú–ï–ß</b><p>F: –†—ã–≤–æ–∫</p></div>
        <div class="weapon-btn" onclick="enterGame('ü•ñ')"><b>–ë–ê–ì–ï–¢</b><p>F: –©–∏—Ç 2 —Å–µ–∫.</p></div>
        <div class="weapon-btn" onclick="enterGame('üçã')"><b>–õ–ò–ú–û–ù</b><p>F: –î–∞–ª—å–Ω–∏–π —É–¥–∞—Ä</p></div>
        <div class="weapon-btn" onclick="enterGame('üé∏')"><b>–ì–ò–¢–ê–†–ê</b><p>F: –ú–æ—â–Ω–∞—è –≤–æ–ª–Ω–∞</p></div>
    </div>

    <div id="hud">
        HP: <span id="myHpText">100</span> | 
        –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å [F]: <div class="cd-bar"><div id="cd-fill"></div></div>
    </div>
    <div id="arena" onmousedown="performAttack()"></div>

<script>
    const firebaseConfig = {
        databaseURL: "https://zitron-blog-default-rtdb.firebaseio.com",
        projectId: "zitron-blog"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = "User_" + Math.floor(Math.random() * 1000);
    let myData = { x: 100, y: 300, vy: 0, hp: 100, wpn: 'üó°Ô∏è', atk: false, inv: false, cd: 0 };
    let keys = {};
    let isPlaying = false;

    function enterGame(weapon) {
        myData.wpn = weapon;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('arena').style.display = 'block';
        document.getElementById('hud').style.display = 'block';
        isPlaying = true;

        db.ref('players/' + myId).set(myData);
        db.ref('players/' + myId).onDisconnect().remove();
    }

    window.onkeydown = e => {
        keys[e.code] = true;
        if (e.code === 'KeyF' && isPlaying && myData.cd <= 0) useAbility();
    };
    window.onkeyup = e => keys[e.code] = false;

    setInterval(() => {
        if (!isPlaying) return;

        if (keys['KeyA']) myData.x -= 8;
        if (keys['KeyD']) myData.x += 8;
        if (keys['Space'] && myData.y >= 350) myData.vy = -16;

        myData.vy += 0.8;
        myData.y += myData.vy;

        if (myData.y > 350) { myData.y = 350; myData.vy = 0; }
        if (myData.x < 0) myData.x = 0;
        if (myData.x > 800) myData.x = 800;

        // –ö—É–ª–¥–∞—É–Ω
        if (myData.cd > 0) {
            myData.cd -= 50;
            document.getElementById('cd-fill').style.width = (myData.cd / 3000 * 100) + "%";
        }

        db.ref('players/' + myId).update({
            x: myData.x, y: myData.y, wpn: myData.wpn, atk: myData.atk, inv: myData.inv
        });
    }, 40);

    function performAttack() {
        if (!isPlaying || myData.atk) return;
        myData.atk = true;
        
        db.ref('players').once('value', snapshot => {
            const players = snapshot.val();
            for (let id in players) {
                if (id !== myId && !players[id].inv) {
                    const enemy = players[id];
                    const dist = Math.hypot(myData.x - enemy.x, myData.y - enemy.y);
                    if (dist < 80) db.ref('players/' + id + '/hp').transaction(hp => (hp || 100) - 10);
                }
            }
        });
        setTimeout(() => { myData.atk = false; }, 300);
    }

    function useAbility() {
        myData.cd = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
        
        if (myData.wpn === 'üó°Ô∏è') { // –†–´–í–û–ö
            myData.x += (keys['KeyA'] ? -150 : 150);
        } 
        else if (myData.wpn === 'ü•ñ') { // –©–ò–¢
            myData.inv = true;
            setTimeout(() => { myData.inv = false; }, 2000);
        }
        else { // –î–ê–õ–¨–ù–ò–ô –ë–û–ô (–õ–∏–º–æ–Ω –∏ –ì–∏—Ç–∞—Ä–∞)
            db.ref('players').once('value', snapshot => {
                const players = snapshot.val();
                for (let id in players) {
                    if (id !== myId && !players[id].inv) {
                        const enemy = players[id];
                        const dist = Math.hypot(myData.x - enemy.x, myData.y - enemy.y);
                        // –õ–∏–º–æ–Ω –±—å–µ—Ç –¥–∞–ª—å—à–µ, –ì–∏—Ç–∞—Ä–∞ –±—å–µ—Ç –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥
                        if (dist < 200) db.ref('players/' + id + '/hp').transaction(hp => (hp || 100) - 20);
                    }
                }
            });
        }
    }

    db.ref('players').on('value', snapshot => {
        if (!isPlaying) return;
        const arena = document.getElementById('arena');
        const players = snapshot.val();
        arena.innerHTML = '';

        for (let id in players) {
            const d = players[id];
            if (id === myId) {
                myData.hp = d.hp;
                document.getElementById('myHpText').innerText = d.hp;
                if (d.hp <= 0) { alert("–í–´ –ü–û–ì–ò–ë–õ–ò!"); location.reload(); }
            }

            const pDiv = document.createElement('div');
            pDiv.className = 'player ' + (id === myId ? 'me' : 'enemy') + (d.inv ? ' invul' : '');
            pDiv.style.left = d.x + 'px'; pDiv.style.top = d.y + 'px';
            pDiv.innerHTML = `<div class="hp-container"><div class="hp-bar" style="width:${d.hp}%"></div></div><div class="name">${id}</div>`;

            const wDiv = document.createElement('div');
            wDiv.className = 'weapon-icon' + (d.atk ? ' atk-anim' : '');
            wDiv.innerText = d.wpn;
            wDiv.style.left = (d.x + 35) + 'px'; wDiv.style.top = (d.y + 5) + 'px';

            arena.appendChild(pDiv);
            arena.appendChild(wDiv);
        }
    });
</script>
</body>
</html>
