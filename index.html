<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ZITRON ARENA | FIXED PVP</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #050505; color: #0f0; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        #lobby { padding: 50px; }
        .weapon-btn { background: #111; border: 2px solid #0f0; color: white; padding: 20px; margin: 10px; cursor: pointer; border-radius: 10px; display: inline-block; width: 150px; }
        .weapon-btn:hover { background: #0f0; color: black; }
        
        #arena { background: #111; border: 5px solid #f00; width: 95vw; height: 70vh; margin: 10px auto; position: relative; overflow: hidden; display: none; }
        
        .player { position: absolute; width: 40px; height: 40px; border-radius: 8px; transition: 0.05s linear; }
        .player.me { background: #00f; border: 2px solid #fff; box-shadow: 0 0 15px #00f; }
        .player.enemy { background: #f00; border: 2px solid #ff4d4d; }
        
        .hp-container { width: 50px; height: 6px; background: #333; position: absolute; top: -15px; left: -5px; border-radius: 3px; }
        .hp-bar { height: 100%; background: #0f0; transition: width 0.2s; }
        .name { position: absolute; top: -30px; width: 100px; left: -30px; font-size: 10px; color: white; }
        .weapon-icon { position: absolute; font-size: 25px; pointer-events: none; z-index: 20; }
        
        .atk-anim { animation: swipe 0.2s ease-in-out; }
        @keyframes swipe { 0% { transform: scale(1); } 50% { transform: scale(1.8) rotate(30deg); } 100% { transform: scale(1); } }
        
        #hud { display: none; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>üçã ZITRON BATTLE ‚öîÔ∏è</h1>
        <div class="weapon-btn" onclick="enterGame('üó°Ô∏è')">–ú–ï–ß üó°Ô∏è</div>
        <div class="weapon-btn" onclick="enterGame('ü•ñ')">–ë–ê–ì–ï–¢ ü•ñ</div>
        <div class="weapon-btn" onclick="enterGame('üçã')">–õ–ò–ú–û–ù üçã</div>
        <div class="weapon-btn" onclick="enterGame('üé∏')">–ì–ò–¢–ê–†–ê üé∏</div>
    </div>

    <div id="hud">HP: <span id="myHpText">100</span> | –û—Ä—É–∂–∏–µ: <span id="myWpnText">-</span></div>
    <div id="arena" onmousedown="performAttack()"></div>

<script>
    const firebaseConfig = {
        databaseURL: "https://zitron-blog-default-rtdb.firebaseio.com",
        projectId: "zitron-blog"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = "Player_" + Math.floor(Math.random() * 1000);
    let myData = { x: 100, y: 300, vy: 0, hp: 100, wpn: 'üó°Ô∏è', atk: false };
    let keys = {};
    let isPlaying = false;

    function enterGame(weapon) {
        myData.wpn = weapon;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('arena').style.display = 'block';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('myWpnText').innerText = weapon;
        isPlaying = true;

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        db.ref('players/' + myId).set(myData);
        db.ref('players/' + myId).onDisconnect().remove();
    }

    window.onkeydown = e => keys[e.code] = true;
    window.onkeyup = e => keys[e.code] = false;

    // –î–≤–∏–∂–µ–Ω–∏–µ –∏ —Ñ–∏–∑–∏–∫–∞
    setInterval(() => {
        if (!isPlaying) return;

        if (keys['KeyA']) myData.x -= 8;
        if (keys['KeyD']) myData.x += 8;
        if (keys['Space'] && myData.y >= 350) myData.vy = -16;

        myData.vy += 0.8;
        myData.y += myData.vy;

        if (myData.y > 350) { myData.y = 350; myData.vy = 0; }
        if (myData.x < 0) myData.x = 0;
        if (myData.x > 800) myData.x = 800;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É –¢–û–õ–¨–ö–û –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –æ—Ä—É–∂–∏–µ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º HP!)
        db.ref('players/' + myId).update({
            x: myData.x,
            y: myData.y,
            wpn: myData.wpn,
            atk: myData.atk
        });
    }, 40);

    // –ê—Ç–∞–∫–∞
    function performAttack() {
        if (!isPlaying || myData.atk) return;
        myData.atk = true;
        
        db.ref('players').once('value', snapshot => {
            const players = snapshot.val();
            for (let id in players) {
                if (id !== myId) {
                    const enemy = players[id];
                    const dist = Math.hypot(myData.x - enemy.x, myData.y - enemy.y);
                    if (dist < 80) {
                        // –ù–∞–Ω–æ—Å–∏–º —É—Ä–æ–Ω —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Äî —ç—Ç–æ —É–±–∏–≤–∞–µ—Ç –•–ò–õ
                        db.ref('players/' + id + '/hp').transaction(hp => (hp || 100) - 15);
                    }
                }
            }
        });

        setTimeout(() => { myData.atk = false; }, 300);
    }

    // –°–ª—É—à–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    db.ref('players').on('value', snapshot => {
        if (!isPlaying) return;
        const arena = document.getElementById('arena');
        const players = snapshot.val();
        
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        arena.innerHTML = '';

        for (let id in players) {
            const d = players[id];
            
            // –ï—Å–ª–∏ —ç—Ç–æ —è, –æ–±–Ω–æ–≤–ª—è–µ–º –º–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ HP
            if (id === myId) {
                myData.hp = d.hp;
                document.getElementById('myHpText').innerText = d.hp;
                if (d.hp <= 0) {
                    alert("–í–ê–° –ü–û–ë–ï–î–ò–õ–ò!");
                    db.ref('players/' + myId).update({hp: 100});
                    location.reload();
                }
            }

            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞
            const pDiv = document.createElement('div');
            pDiv.className = 'player ' + (id === myId ? 'me' : 'enemy');
            pDiv.style.left = d.x + 'px';
            pDiv.style.top = d.y + 'px';
            
            // HP –ø–æ–ª–æ—Å–∫–∞
            pDiv.innerHTML = `
                <div class="hp-container"><div class="hp-bar" style="width:${d.hp}%"></div></div>
                <div class="name">${id}</div>
            `;

            // –û—Ä—É–∂–∏–µ
            const wDiv = document.createElement('div');
            wDiv.className = 'weapon-icon' + (d.atk ? ' atk-anim' : '');
            wDiv.innerText = d.wpn;
            wDiv.style.left = (d.x + 35) + 'px';
            wDiv.style.top = (d.y + 5) + 'px';

            arena.appendChild(pDiv);
            arena.appendChild(wDiv);
        }
    });
</script>
</body>
</html>
